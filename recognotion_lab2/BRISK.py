import numpy as np
import time
import cv2
import matplotlib.pyplot as plt
imagesTurtle = []
imagesMrPotato =[]
metrik1TAkaze = [0.01511879049676026, 0.03023758099352052, 0.07127429805615551, 0.02159827213822894, 0.06803455723542116, 0.028077753779697623, 0.009719222462203024, 0.02267818574514039, 0.019438444924406047, 0.0183585313174946, 0.0183585313174946, 0.02591792656587473, 0.019438444924406047, 0.014038876889848811, 0.02159827213822894, 0.029157667386609073, 0.023758099352051837, 0.026997840172786176, 0.03995680345572354, 0.028077753779697623, 0.023758099352051837, 0.023758099352051837, 0.026997840172786176, 0.02267818574514039, 0.02267818574514039, 0.020518358531317494, 0.016198704103671708, 0.029157667386609073, 0.026997840172786176, 0.0183585313174946, 0.014038876889848811, 0.016198704103671708, 0.0183585313174946, 0.03347732181425486, 0.06263498920086392, 0.03023758099352052, 0.028077753779697623, 0.014038876889848811, 0.03131749460043196, 0.01511879049676026, 0.04427645788336933, 0.02591792656587473, 0.032397408207343416, 0.02267818574514039, 0.024838012958963283, 0.019438444924406047, 0.056155507559395246, 0.0367170626349892, 0.026997840172786176, 0.03995680345572354, 0.03347732181425486, 0.02267818574514039, 0.014038876889848811, 0.024838012958963283, 0.016198704103671708, 0.03455723542116631, 0.02159827213822894, 0.012958963282937365, 0.032397408207343416, 0.038876889848812095, 0.020518358531317494, 0.016198704103671708, 0.032397408207343416, 0.024838012958963283, 0.02591792656587473, 0.023758099352051837, 0.04643628509719223, 0.023758099352051837, 0.028077753779697623, 0.016198704103671708, 0.026997840172786176, 0.01511879049676026, 0.029157667386609073, 0.029157667386609073, 0.07127429805615551, 0.06803455723542116, 0.02159827213822894, 0.028077753779697623, 0.005399568034557235, 0.011879049676025918, 0.032397408207343416, 0.0183585313174946, 0.032397408207343416, 0.024838012958963283, 0.032397408207343416, 0.03779697624190065, 0.03455723542116631, 0.03347732181425486, 0.019438444924406047, 0.03779697624190065, 0.03023758099352052, 0.028077753779697623, 0.03455723542116631, 0.032397408207343416, 0.024838012958963283, 0.0367170626349892, 0.02159827213822894, 0.04103671706263499, 0.03023758099352052, 0.03023758099352052,0.0367170626349892]
metrik3TAkaze = [0.41190004348754883, 0.4148902893066406, 0.516632080078125, 0.4497983455657959, 0.5146245956420898, 0.47672128677368164, 0.4568135738372803, 0.5345721244812012, 0.46475768089294434, 0.47373294830322266, 0.4377889633178711, 0.45478391647338867, 0.4608027935028076, 0.4358363151550293, 0.43486976623535156, 0.42885375022888184, 0.4438130855560303, 0.45075488090515137, 0.4268605709075928, 0.44380974769592285, 0.4338407516479492, 0.43782782554626465, 0.43782639503479004, 0.43783044815063477, 0.4528238773345947, 0.4358348846435547, 0.45382189750671387, 0.43783116340637207, 0.4428532123565674, 0.4637598991394043, 0.4388313293457031, 0.45278406143188477, 0.4497964382171631, 0.45079612731933594, 0.43483901023864746, 0.4637596607208252, 0.4338386058807373, 0.444810152053833, 0.4357931613922119, 0.4278721809387207, 0.4338374137878418, 0.43178796768188477, 0.42985081672668457, 0.4278557300567627, 0.4497950077056885, 0.4338407516479492, 0.42885351181030273, 0.42984819412231445, 0.44077467918395996, 0.4308462142944336, 0.4318113327026367, 0.42885422706604004, 0.45677804946899414, 0.438861608505249, 0.4578099250793457, 0.42287135124206543, 0.4138946533203125, 0.45674681663513184, 0.4258613586425781, 0.45778584480285645, 0.49068665504455566, 0.47572922706604004, 0.43782806396484375, 0.4507942199707031, 0.4388253688812256, 0.4527883529663086, 0.42786288261413574, 0.4248647689819336, 0.4318809509277344, 0.4377865791320801, 0.4388265609741211, 0.45079565048217773, 0.43683338165283203, 0.44087815284729004, 0.49164819717407227, 0.49863600730895996, 0.4517936706542969, 0.43483781814575195, 0.5086419582366943, 0.5106344223022461, 0.4358351230621338, 0.43288731575012207, 0.4408574104309082, 0.43080925941467285, 0.4308145046234131, 0.4338045120239258, 0.435835599899292, 0.43579530715942383, 0.4447779655456543, 0.43483734130859375, 0.4298105239868164, 0.43284153938293457, 0.44785618782043457, 0.42186832427978516, 0.42087459564208984, 0.41585516929626465, 0.4308052062988281, 0.42290377616882324, 0.4248661994934082, 0.43383264541625977,0.8487708568572998]
metrik1PAkaze = [0.025219298245614034, 0.03070175438596491, 0.017543859649122806, 0.03618421052631579, 0.11732456140350878, 0.14364035087719298, 0.10635964912280702, 0.17105263157894737, 0.07017543859649122, 0.041666666666666664, 0.025219298245614034, 0.025219298245614034, 0.02631578947368421, 0.10416666666666667, 0.02631578947368421, 0.02412280701754386, 0.020833333333333332, 0.01644736842105263, 0.020833333333333332, 0.03837719298245614, 0.027412280701754384, 0.03508771929824561, 0.01864035087719298, 0.03179824561403509, 0.015350877192982455, 0.015350877192982455, 0.021929824561403508, 0.03728070175438596, 0.046052631578947366, 0.039473684210526314, 0.029605263157894735, 0.03179824561403509, 0.023026315789473683, 0.027412280701754384, 0.01206140350877193, 0.06030701754385965, 0.039473684210526314, 0.013157894736842105, 0.020833333333333332, 0.019736842105263157, 0.017543859649122806, 0.027412280701754384, 0.017543859649122806, 0.017543859649122806, 0.021929824561403508, 0.020833333333333332, 0.03179824561403509, 0.03289473684210526, 0.021929824561403508, 0.027412280701754384, 0.06798245614035088, 0.023026315789473683, 0.0581140350877193, 0.039473684210526314, 0.05043859649122807, 0.03399122807017544, 0.03399122807017544, 0.02631578947368421, 0.047149122807017545, 0.05263157894736842, 0.020833333333333332, 0.03179824561403509, 0.06030701754385965, 0.041666666666666664, 0.06798245614035088, 0.02412280701754386, 0.015350877192982455, 0.03728070175438596, 0.02850877192982456, 0.015350877192982455, 0.02631578947368421, 0.027412280701754384, 0.041666666666666664, 0.049342105263157895, 0.027412280701754384, 0.0800438596491228, 0.019736842105263157, 0.025219298245614034, 0.017543859649122806, 0.015350877192982455, 0.015350877192982455, 0.0581140350877193, 0.03837719298245614, 0.03508771929824561, 0.04057017543859649, 0.03289473684210526, 0.019736842105263157, 0.020833333333333332, 0.03728070175438596, 0.041666666666666664, 0.019736842105263157, 0.029605263157894735, 0.015350877192982455, 0.02631578947368421, 0.03508771929824561, 0.03179824561403509, 0.02631578947368421, 0.039473684210526314, 0.043859649122807015, 0.047149122807017545, 0.02850877192982456, 0.02850877192982456, 0.049342105263157895, 0.01864035087719298, 0.019736842105263157, 0.01864035087719298, 0.019736842105263157, 0.021929824561403508, 0.021929824561403508, 0.015350877192982455, 0.020833333333333332, 0.015350877192982455, 0.019736842105263157, 0.03618421052631579]
metrik3PAkaze = [0.37200355529785156, 0.3679783344268799, 0.36198997497558594, 0.3660566806793213, 0.3639707565307617, 0.36298418045043945, 0.36402368545532227, 0.37894606590270996, 0.3620293140411377, 0.40295958518981934, 0.36601805686950684, 0.3670179843902588, 0.3620290756225586, 0.3730027675628662, 0.3749990463256836, 0.3780248165130615, 0.3759589195251465, 0.36398935317993164, 0.3590724468231201, 0.3609943389892578, 0.24829792976379395, 0.25627756118774414, 0.40086817741394043, 0.3630239963531494, 0.3670186996459961, 0.377979040145874, 0.3699793815612793, 0.2603034973144531, 0.2543156147003174, 0.24231553077697754, 0.3670196533203125, 0.3749377727508545, 0.36498308181762695, 0.3610665798187256, 0.3609962463378906, 0.3610343933105469, 0.36997437477111816, 0.2543206214904785, 0.24836134910583496, 0.35800766944885254, 0.3799467086791992, 0.377988338470459, 0.3739614486694336, 0.3689744472503662, 0.24829959869384766, 0.25129103660583496, 0.3629932403564453, 0.3610203266143799, 0.3968961238861084, 0.37795281410217285, 0.3609957695007324, 0.3600351810455322, 0.35700535774230957, 0.358004093170166, 0.2572746276855469, 0.2623000144958496, 0.25727319717407227, 0.2492969036102295, 0.24829864501953125, 0.37496089935302734, 0.36099696159362793, 0.3580358028411865, 0.3669853210449219, 0.3729684352874756, 0.36199140548706055, 0.36901021003723145, 0.35399723052978516, 0.36103200912475586, 0.36698126792907715, 0.39893174171447754, 0.3720059394836426, 0.3949089050292969, 0.37699151039123535, 0.3829379081726074, 0.37405896186828613, 0.38796257972717285, 0.35504770278930664, 0.359999418258667, 0.3640604019165039, 0.36003637313842773, 0.36402249336242676, 0.36698102951049805, 0.3730020523071289, 0.25731563568115234, 0.25427985191345215, 0.2543206214904785, 0.35903453826904297, 0.3660614490509033, 0.36003661155700684, 0.3709678649902344, 0.3829319477081299, 0.3729689121246338, 0.362030029296875, 0.3809843063354492, 0.3669772148132324, 0.359999418258667, 0.35900259017944336, 0.37595486640930176, 0.36698102951049805, 0.3809795379638672, 0.36100006103515625, 0.3659827709197998, 0.3600575923919678, 0.19942808151245117, 0.36701488494873047, 0.3670179843902588, 0.34707212448120117, 0.3679821491241455, 0.362030029296875, 0.3500645160675049, 0.3659813404083252, 0.4008924961090088, 0.39294910430908203, 0.3839149475097656]
metrik2TAkaze = [109.82451403887688, 120.57721382289417, 119.3169546436285, 119.20086393088553, 112.77915766738661, 123.97354211663067, 112.2975161987041, 113.50809935205183, 113.89092872570194, 125.37041036717062, 130.85691144708423, 110.6182505399568, 108.96652267818574, 139.11555075593952, 115.76133909287257, 117.53023758099351, 122.9622030237581, 115.7170626349892, 135.85961123110152, 111.12904967602591, 121.46976241900649, 119.99298056155507, 111.17278617710583, 122.55345572354211, 115.68952483801296, 129.841252699784, 114.51241900647948, 123.53833693304536, 118.54859611231102, 116.20572354211663, 122.49352051835854, 114.9011879049676, 109.95518358531318, 114.16738660907127, 142.11771058315335, 131.68574514038878, 122.57991360691145, 124.16522678185746, 129.31263498920086, 132.3952483801296, 131.75053995680346, 121.01835853131749, 121.16468682505399, 120.44330453563715, 116.04535637149029, 126.64524838012959, 124.86987041036717, 132.6123110151188, 121.46274298056156, 119.73650107991361, 118.41630669546436, 123.14200863930886, 114.01295896328294, 120.90388768898488, 108.09287257019439, 125.68088552915766, 120.31641468682506, 116.30561555075595, 123.08261339092873, 126.3768898488121, 114.7354211663067, 117.86717062634989, 121.00647948164146, 115.96760259179266, 128.48488120950324, 124.82019438444924, 130.49730021598273, 121.55345572354211, 122.24838012958963, 118.44492440604752, 114.22516198704103, 111.2829373650108, 125.21058315334773, 121.54481641468682, 119.3169546436285, 112.77915766738661, 110.2181425485961, 122.17710583153348, 128.52375809935205, 111.54481641468682, 114.80831533477321, 123.70680345572354, 116.0475161987041, 124.28347732181426, 129.76025917926566, 123.7462203023758, 122.54427645788337, 139.99190064794817, 116.78617710583153, 120.03887688984881, 132.40064794816413, 114.02699784017278, 123.21652267818574, 143.63228941684665, 124.76025917926566, 123.83855291576674, 115.82775377969763, 146.3196544276458, 124.79913606911447, 118.91522678185746, 123.63390928725703]
metrik2PAkaze = [137.06030701754386, 142.94243421052633, 138.53344298245614, 133.84265350877192, 115.8530701754386, 115.24561403508773, 121.5032894736842, 115.80427631578948, 126.01699561403508, 122.87006578947368, 126.74835526315789, 129.5844298245614, 127.48848684210526, 118.6030701754386, 124.99451754385964, 125.96436403508773, 125.58333333333333, 130.68530701754386, 139.6326754385965, 155.66995614035088, 156.2017543859649, 158.55098684210526, 123.72478070175438, 132.34868421052633, 135.46162280701753, 134.79605263157896, 127.46052631578948, 144.6003289473684, 140.15679824561403, 141.6233552631579, 150.03947368421052, 129.56743421052633, 126.5904605263158, 132.19736842105263, 130.70723684210526, 126.41228070175438, 137.60745614035088, 153.99506578947367, 148.23190789473685, 131.13870614035088, 121.44024122807018, 122.86074561403508, 124.78837719298245, 123.76151315789474, 141.4890350877193, 139.8733552631579, 123.44736842105263, 123.82510964912281, 137.13651315789474, 154.43366228070175, 175.43421052631578, 163.5219298245614, 127.09813596491227, 129.28947368421052, 139.81140350877192, 144.41337719298247, 147.0701754385965, 144.6469298245614, 133.45120614035088, 120.65186403508773, 134.98190789473685, 129.43366228070175, 121.33114035087719, 122.93311403508773, 123.60197368421052, 122.48684210526316, 132.88651315789474, 128.13048245614036, 123.95394736842105, 122.26206140350877, 131.6030701754386, 133.05921052631578, 132.86513157894737, 126.4906798245614, 129.484649122807, 125.16282894736842, 126.77631578947368, 130.640350877193, 128.1765350877193, 129.625, 129.73629385964912, 121.03837719298245, 121.31524122807018, 133.46546052631578, 127.33333333333333, 133.75603070175438, 126.28015350877193, 124.35690789473684, 123.67543859649123, 127.00603070175438, 126.50603070175438, 125.10087719298245, 127.42598684210526, 121.43530701754386, 132.90679824561403, 124.68366228070175, 123.22587719298245, 128.1655701754386, 134.94188596491227, 131.2390350877193, 125.11293859649123, 123.72368421052632, 124.27686403508773, 161.86787280701753, 158.59484649122808, 146.94024122807016, 139.82730263157896, 131.7280701754386, 134.65405701754386, 139.61348684210526, 132.46162280701753, 133.84155701754386, 134.32456140350877, 137.81524122807016]
times = []
localss =[]
metrik2 =[]
metrik1T=[]
metrik2T=[]
metrik3T=[]
metrik1P = []
metrik2P = []
metrik3P = []
good_matches = []
fT= open("resultsTurtle.txt","w+")
fT.write("good                   metrik 2                       time\n")
fP= open("resultsMrPotato.txt","w+")
fP.write("good                   metrik 2                       time\n")
for i in range(1,102):
    imagesTurtle.append(cv2.imread('turtle ({0}).jpg'.format(i),0))
for i in range(1,115):
    imagesMrPotato.append(cv2.imread('Mr.Potato/im{0}.jpg'.format(i), 0))


imgT = cv2.imread('turtle.jpg',0)
imgP = cv2.imread('Mr.Potato/im0.jpg',0)
brisk = cv2.BRISK_create()
(kpT,desT) = brisk.detectAndCompute(imgT,None)
(kpP,desP) = brisk.detectAndCompute(imgP,None)

def process_Image(i,des,kp,img,images,file,metrik1,metrik2,metrik3):
    img2 = images[i]

    time1 = time.time()



    #print(len(kp1))
    (kp2,des2) = brisk.detectAndCompute(img2,None)
    #print(len(kp2))
    metrik3.append(time.time() - time1)

    des1_conv = des.astype('float32')
    des2_conv = des2.astype('float32')

    bf = cv2.BFMatcher(cv2.NORM_HAMMING, crossCheck=True)

    matches = bf.match(des,des2)
    print(len(matches))

    matches = sorted(matches, key=lambda val: val.distance)
    print(len(matches))
    matcher = cv2.DescriptorMatcher_create(cv2.DescriptorMatcher_FLANNBASED)
    if (len(kp2) < 2):
        metrik1.append(0)
        metrik2.append(np.nan)
    else:
        knn_matches = matcher.knnMatch(des1_conv, des2_conv, 2)
    # -- Filter matches using the Lowe's ratio test
        ratio_thresh = 0.8

        good = 0.0
        for m, n in knn_matches:
            if m.distance < ratio_thresh * n.distance:
                good+=1
            localss.append((m.distance+n.distance)/2.0)
        metrik1.append(good/len(knn_matches))
        print(good_matches)
        metrik2.append(np.mean(localss))

    img3 = cv2.drawMatches(img,kp,img2,kp2,matches ,None, flags=2)

    file.write(str(np.round(np.array(metrik1[i]),5))+"                "+str(np.round(np.array(metrik2[i]),5))+"               "+str(metrik3[i])+"\n")

    #plt.imshow(img3)
    #plt.show()
print("TURTLE\n")
for i in range(len(imagesTurtle)):
    process_Image(i,desT,kpT,imgT,imagesTurtle,fT,metrik1T,metrik2T,metrik3T)
    cv2.waitKey(0)
print("Mr Pot\n")
for i in range(len(imagesMrPotato)):
    process_Image(i,desP,kpP,imgP,imagesMrPotato,fP,metrik1P,metrik2P,metrik3P)
    cv2.waitKey(0)
#print("metrik1 potato")
#print(metrik1P)
f1,(ax1,ax2,ax3) = plt.subplots(1,3,sharex=True)
f1.suptitle("Turtle analysis")
ax1.plot(range(1,len(imagesTurtle)+1),metrik1T,label = "metric 1 by BRISK")
ax1.plot(range(1,len(imagesTurtle)+1),metrik1TAkaze, label = "metric 1 by Akaze")
ax1.legend()
ax2.plot(range(1,len(imagesTurtle)+1),metrik2T, label = "metric 2 by brisk")
ax2.plot(range(1,len(imagesTurtle)+1),metrik2TAkaze, label = "metric 2 by Akaze")
ax2.legend()
ax3.plot(range(1,len(imagesTurtle)+1),metrik3T, label = "metric 3 by brisk")
ax3.plot(range(1,len(imagesTurtle)+1),metrik3TAkaze, label = "metric 3 by Akaze")
ax3.legend()

f2,(bx1,bx2,bx3) = plt.subplots(1,3,sharex=True)
f2.suptitle("Mr Potato analysis")
bx1.plot(range(1,len(imagesMrPotato)+1),metrik1P,label = "metric 1 by BRISK")
bx1.plot(range(1,len(imagesMrPotato)+1),metrik1PAkaze, label = "metric 1 by Akaze")
bx1.legend()
bx3.plot(range(1,len(imagesMrPotato)+1),metrik3P, label = "metric 3 by brisk")
bx3.plot(range(1,len(imagesMrPotato)+1),metrik3PAkaze, label = "metric 3 by Akaze")
bx3.legend()
bx2.plot(range(1,len(imagesMrPotato)+1),metrik2P, label = "metric 2 by brisk")
bx2.plot(range(1,len(imagesMrPotato)+1),metrik2PAkaze, label = "metric 2 by Akaze")
bx2.legend()
plt.show()
